var d=class{clients;server;module;constructor(t){this.clients=new Map,this.module=t,this.server=t._psp_new_server()}make_session(t){let n=this.module._psp_new_session(this.server);return this.clients.set(n,t),new v(this.module,this.server,n,this.clients)}delete(){this.module._psp_delete_server(this.server)}},v=class{constructor(t,n,s,i){this.mod=t;this.server=n;this.client_id=s;this.client_map=i}async handle_request(t){let n=await M(this.mod,t,async s=>this.mod._psp_handle_request(this.server,this.client_id,s,this.mod._psp_is_memory64()?BigInt(t.byteLength):t.byteLength));await w(this.mod,n,async s=>{await this.client_map.get(s.client_id)(s.data)})}poll(){let t=this.mod._psp_poll(this.server);w(this.mod,t,async n=>{await this.client_map.get(n.client_id)(n.data)})}close(){this.mod._psp_close_session(this.server,this.client_id)}};async function M(a,t,n){let s=a._psp_alloc(a._psp_is_memory64()?BigInt(t.byteLength):t.byteLength);a.HEAPU8.set(t,Number(s));let i=await n(s);return a._psp_free(s),i}async function w(a,t,n){let s=a._psp_is_memory64(),i=new DataView(a.HEAPU8.buffer,Number(t),s?12:8),c=i.getUint32(0,!0),l=s?i.getBigInt64(4,!0):i.getUint32(4,!0),e=new DataView(a.HEAPU8.buffer,Number(l),c*(s?16:12));try{for(let r=0;r<c;r++){let[o,p,f]=s?[e.getBigInt64(r*16,!0),e.getInt32(r*16+8,!0),e.getInt32(r*16+12,!0)]:[e.getInt32(r*12,!0),e.getInt32(r*12+4,!0),e.getInt32(r*12+8,!0)],_=new Uint8Array(a.HEAPU8.buffer,Number(o),p);await n({client_id:f,data:_})}}finally{for(let r=0;r<c;r++){let o=s?e.getBigInt64(r*16,!0):e.getInt32(r*12,!0);a._psp_free(o)}a._psp_free(s?BigInt(e.byteOffset):e.byteOffset),a._psp_free(s?BigInt(i.byteOffset):i.byteOffset)}}var B=console.log.bind(console),I=console.error.bind(console),x=new TextDecoder("utf8"),H=[null,[],[]];function N(a,t=0,n=NaN){for(var s=t+n,i=t;a[i]&&!(i>=s);)++i;return x.decode(a instanceof Uint8Array?a.subarray(t,i):new Uint8Array(a.slice(t,i)))}function A(a,t){var n=H[a];t===0||t===10?((a===1?B:I)(N(n,0)),n.length=0):n.push(t)}async function P(a){let t,n=!1,s,i={HaveOffsetConverter(){console.error("HaveOffsetConverter")},__syscall_ftruncate64(...e){console.error("__syscall_frtuncate64",e)},__syscall_getdents64(...e){console.error("__syscall_frtuncate64",e)},__syscall_unlinkat(...e){console.error("__syscall_frtuncate64",e)},__throw_exception_with_stack_trace(e){let r=new WebAssembly.Exception(t.__cpp_exception,[e],{traceStack:!0});throw r.message="Unexpected internal error",r},clock_time_get(e,r,o){if(n){if(o=o,o=Number(o),!(e==0||e==1||e==2||e==3))return 28;var p;e===0?p=Date.now():p=performance.now();let _=Math.round(p*1e3*1e3),u=new BigInt64Array(s.buffer);return u[o/8]=BigInt(_),0}else{if(o=o,o>>>=0,!(e==0||e==1||e==2||e==3))return 28;var p;e===0?p=Date.now():p=performance.now();var f=Math.round(p*1e6);let u=new BigInt64Array(s.buffer);return u[o>>>3]=BigInt(f),0}},emscripten_asm_const_int(...e){return 0},emscripten_notify_memory_growth(e){n?e=Number(e):(e=e,e>>>=0),e!=0&&console.error("abort")},environ_get(...e){return 0},environ_sizes_get(...e){return 0},fd_close(...e){return console.error("fd_close",e),0},fd_read(...e){return console.error("fd_read",e),0},fd_seek(...e){return console.error("fs_seek",e),0},fd_write(e,r,o,p){let f=new Uint8Array(s.buffer);if(n){r=Number(r),o=Number(o),p=Number(p);let _=0,u=new BigUint64Array(s.buffer);for(let y=0;y<o;y++){let g=Number(u[r/8]),b=Number(u[(r+8)/8]);r+=16;for(let m=0;m<b;m++)A(e,f[g+m]);_+=b}return u[p/8]=BigInt(_),0}else{r=r,o=o,p=p,r>>>=0,o>>>=0,p>>>=0;let _=0,u=new Uint32Array(s.buffer);for(let y=0;y<o;y++){let g=u[r>>>2>>>0],b=u[r+4>>>2>>>0];r+=8;for(let m=0;m<b;m++)A(e,f[g+m>>>0]);_+=b}return u[p>>>2>>>0]=_,0}},proc_exit(e){return console.error("proc_exit",e),0}},c=await a.instantiateWasm({env:i,wasi_snapshot_preview1:i},e=>{t=e.exports,n=!!t.psp_is_memory64(),s=e.exports.memory,t._initialize()}),l={};for(let[e,r]of Object.entries(c))l[`_${e}`]=r;return{...c,...l,get HEAPU8(){return new Uint8Array(s.buffer)}}}async function U(a){let t=await P({locateFile(n){return n},instantiateWasm:async(n,s)=>{n.env={...n.env,psp_stack_trace(){let c=Error().stack||"",e=new TextEncoder().encode(c),r=t._psp_alloc(t._psp_is_memory64()?BigInt(e.byteLength+1):e.byteLength+1);return t.HEAPU8.set(e,Number(r)),t.HEAPU8[Number(r)+e.byteLength]=0,r},psp_heap_size(){return t._psp_is_memory64()?BigInt(t.HEAPU8.buffer.byteLength):t.HEAPU8.buffer.byteLength}};let i=await WebAssembly.instantiate(a,n);return s(i.instance),i.instance.exports}});return t}var h;function E(a){let t=a.ports[0],n;t.addEventListener("message",async s=>{if(s.data.cmd==="init"){let i=s.data.id;if(!h){let c=await U(s.data.args[0]);h=new d(c)}n=h.make_session(async c=>{let l=c.slice().buffer;t.postMessage(l,{transfer:[l]})}),t.postMessage({id:i})}else n.handle_request(new Uint8Array(s.data)),setTimeout(()=>n.poll())}),t.start()}self.addEventListener("connect",E);self.addEventListener("message",E);
//# sourceMappingURL=perspective-server.worker.js.map
